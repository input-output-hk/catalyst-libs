VERSION 0.8

IMPORT github.com/input-output-hk/catalyst-ci/earthly/rust:v3.2.03 AS rust-ci

# sync-cfg: Synchronize local config with CI version.
# Must be run by the developer manually.
sync-cfg:
    DO rust-ci+SYNC_STD_CFG

# builder : Set up our target toolchains, and copy our files.
builder:
    DO rust-ci+SETUP
    RUN --no-cache

    COPY Cargo.toml clippy.toml deny.toml rustfmt.toml .
    COPY --dir .cargo .config c509-certificate cardano-chain-follower \
                cbork cbork-abnf-parser cbork-cddl-parser \
                hermes-ipfs  .

# check : Run basic check.
check:
    FROM +builder

    DO rust-ci+EXECUTE --cmd="/scripts/std_checks.py"

# build : Build crates.
build:
    FROM +builder

    RUN --no-cache
    DO rust-ci+EXECUTE \
        --cmd="/scripts/std_build.py" \
        --output="release/[^\./]+" \
        --args1="--libs=c509-certificate" \
        --args2="--libs=cardano-chain-follower" \
        --args3="--libs=cbork-cddl-parser" \
        --args4="--libs=cbork-abnf-parser" \
        --args5="--libs=hermes-ipfs" \
        --args6="--bins=cbork/cbork" \
        --docs="true"

    SAVE ARTIFACT target/$TARGETARCH/doc doc
    SAVE ARTIFACT target/release/cbork cbork


# local-ci-run: This step simulates the full CI run for local purposes only.
local-ci-run:
    BUILD +check
    BUILD +build